# 勤務表自動生成ツール

本ツールは **Python + PuLP** を用いた数理最適化によって、病院間の勤務割り当てを自動で作成します。  
勤務希望や病院側の指定日、最大勤務回数などを入力として、ハード制約を満たしつつソフト制約をできるだけ満たす勤務表を生成します。

---

## 初期設定

**GUI版を使用する場合、複雑な初期設定は不要です。** GUI起動スクリプトが必要な環境を自動的にセットアップします。

### 簡単セットアップ（GUI版）

**Windows:**

1. `launch-gui.bat` をダブルクリック
2. 必要に応じてPythonとuvが自動インストールされます(初回は起動に時間がかかります)
3. 環境構築後、GUIが起動します

**macOS:**

1. `launch-gui.command` をダブルクリック
2. 必要に応じてuvが自動インストールされます（Homebrewまたは公式インストーラー）
3. 環境構築後、GUIが起動します

> **注意**: macOSでは初回実行時に「開発者を確認できません」と表示される場合があります。その場合は右クリック→「開く」を選択してください。

### 手動セットアップ（CLI版や開発者向け）

<details>
<summary>詳細な環境構築が必要な場合（クリックで展開）</summary>

1. **Python 3.13以上をインストール**
   - [Python公式サイト](https://www.python.org/downloads/) から最新版をダウンロード
   - インストール確認: `python3 --version`

2. **uvをインストール**

   ```bash
   pip install uv
   # または macOS の場合: brew install uv
   ```

3. **プロジェクトフォルダで依存関係をインストール**
   ```bash
   cd path/to/OptiRoster
   uv sync
   ```

</details>

---

## 使い方

### GUI版（推奨）

#### GUI起動方法

**Windows:**

1. `launch-gui.bat` をダブルクリック

**macOS:**

1. `launch-gui.command` をダブルクリック

> **注意**: macOSでは初回実行時に「開発者を確認できません」と表示される場合があります。その場合は右クリック→「開く」を選択してください。

**Linux:**

```bash
uv run -m src.gui.app
```

#### GUIの使い方

1. **勤務希望CSV選択**
   - 「勤務希望csv選択」ボタンをクリック
   - Google Formからダウンロードした勤務希望CSVファイルを選択

2. **処理実行**
   - 「処理実行」ボタンをクリック
   - 最適化処理が開始され、進行状況がログに表示されます
   - 処理完了時に結果の詳細（ペナルティ、人員不足等）が表示されます

3. **結果保存**
   - 「勤務表Excel出力」ボタンをクリック
   - 保存先を選択してExcelファイルを出力

4. **設定編集（設定タブ）**
   - 「勤務回数上限設定」: 最大割り当て数の編集
   - 「病院別勤務希望日設定」: 指定日設定の編集
   - その他の設定ファイル（TOML/CSV/JSON）の編集が可能

#### 必要な設定ファイル

GUIを使用する前に、以下のファイルが適切に配置されている必要があります：

- `config/hospitals.toml` : 病院設定
- `config/workers.toml` : 勤務者設定
- `data/max-assignments.csv` : 最大勤務回数設定
- `data/specified-dates.toml` : 病院別指定日設定（GUIはこの固定ファイルを読み込みます）

> 対象月ごとにファイルを分けたい場合は、`data/specified-dates.toml` をコピー・リネームして編集した後、GUI用には最新の内容を `data/specified-dates.toml` に戻してください。
> GUIの"設定"タブから"設定ファイルを選択"から設定ファイルを編集できます。csvファイルを編集する場合は、ファイル選択ダイアログでファイル種別をcsvに変更してください。

---

### CLI版（上級者向け）

<details>
<summary>コマンドラインでの詳細な制御が必要な場合のオプション（クリックで展開）</summary>

#### 短縮コマンド

```bash
uv run -m src.cli.main \
  -y 2025 -m 10 \
  -s data/specified-2025-10.toml \
  -p data/2025-10.csv \
  -a data/max-assignments.csv \
  -x output.xlsx
```

#### フルコマンド

```bash
uv run -m src.cli.main \
  --year 2025 --month 10 \
  --specified-days data/specified-2025-10.toml \
  --preferences data/2025-10.csv \
  --max-assignments-csv data/max-assignments.csv \
  --xlsx output.xlsx
```

#### 利用可能な短縮オプション

**必須引数:**

- `-y, --year` : 対象年
- `-m, --month` : 対象月
- `-s, --specified-days` : 病院の勤務指定日TOMLファイル
- `-p, --preferences` : 勤務希望CSVファイル

**オプション引数:**

- `-a, --max-assignments-csv` : 最大割り当て数CSVファイル
- `-H, --hospitals` : 病院設定TOMLファイル
- `-w, --workers` : 勤務者設定TOMLファイル
- `-x, --xlsx` : Excel出力パス
- `-j, --json` : JSON形式で出力

#### 毎月変更する部分

- `-y`/`--year` と `-m`/`--month` を対象年月に変更してください。
- `-s`/`--specified-days` を当該月の指定日ファイルに変更してください。
  （例: `data/specified-2025-11.toml`）
- `-p`/`--preferences` を当該月の勤務希望 CSV に変更してください。
  （Google Form からダウンロードした CSV をそのまま利用可）
- `-a`/`--max-assignments-csv` を当該月の設定に合わせて編集してください。

#### 変更不要な部分

- `-H`/`--hospitals` (config/hospitals.toml)
- `-w`/`--workers` (config/workers.toml)
  これらはメンバーや病院の基本情報が変わらない限り編集不要です。

</details>

---

## 設定ファイル

- **固定ファイル（基本的に毎月共通）**
  - `config/hospitals.toml` : 病院の情報（大学、外勤先、曜日ごとの需要など）
  - `config/workers.toml` : 勤務者の情報（専門医属性、担当可能な曜日・シフトなど）

- **月ごとに編集・指定が必要なファイル**
  - `data/YYYY-MM.csv` : 勤務希望（Google Form からエクスポートした CSV）
  - `data/specified-dates.toml` : GUI版が参照する指定日設定（最新の対象月をここに反映）
  - `data/specified-YYYY-MM.toml` : CLI版で利用する病院側指定日リスト
  - `data/max-assignments.csv` : 各勤務者 × 病院の最大勤務回数を設定  
    → 隔月勤務や 3 ヶ月に 1 回の勤務を表現可能

---

## 制約

### ハード制約(必ず順守すべき制約)

違反がある場合、GUIのログで**赤色**で表示

- 各病院・各日に 1 人の勤務者を割り当てる
- 同日同時刻に複数病院へ勤務不可
- 勤務希望で「当直不可」「日勤・当直不可」の条件を満たす
- 大学病院の休日最終日の当直は診断専門医のみ
- 当直翌日の遠隔地勤務 (Day/AM) 禁止
- 最大勤務回数制限 (max-assignments.csv に基づく)

### ソフト制約(可能な限り順守する制約)

違反がある場合、GUIのログで**黄色**で表示

- 当直間隔をできるだけ広げる（連続禁止はハード制約で保証）
- 当直回数の偏りをできるだけ少なくする（休日の日当直は1.5回換算）
- 当直以外の勤務も曜日ごとに均等化
- 当直と遠隔地勤務(Day/PM) の同日割り当ては避ける
- 当直翌日の外勤を避ける（Day/AM の割り当てを回避）

---

## 隔月などの勤務への対応

### AさんとBさんが隔月で病院Xに交代勤務する場合

- 今月が A さんの月であれば:
  - `max-assignments.csv` で A さんの上限を枠数に設定（例: 1）
  - B さんの上限を 0 に設定
- 3 ヶ月に 1 回なども同様に設定可能

### 病院Xの金曜勤務者が4人おり、その月に金曜が5回ある場合

- A さんに 2 回入ってほしい場合:
  - `max-assignments.csv` で A さんを 2
  - 他の3人を 1 に設定
- 同様に勤務回数のバランスを調整する場合は`max-assignments.csv`で設定

### 大学当直を火曜・水曜限定にしたい場合

- `workers.toml` の該当勤務者の設定で

  ```toml
  weekdays = ["火曜", "水曜"]
  ```

### AさんとBさんで病院Yの毎週勤務を4~5回担当し、勤務日はAさんの希望を優先したい場合

- `勤務希望csv` で A さんの希望する場所以外を「日勤・当直不可」に設定
  - 例: 第1・2・5金曜日が希望の場合 -> 第3・4金曜日を「日勤・当直不可」に設定
- `max-assignments.csv` で病院Yの勤務回数を合わせて設定
  - 上記の場合、Aさんを 3、Bさんを 2 に設定

---

## 出力

### GUI版

- 処理結果がログウィンドウに表示されます
  - 最適化状況（制約数、変数数、求解時間等）
  - ペナルティ詳細（制約別の合計と上位項目）
  - 人員不足の詳細（病院・日付別）
- 「勤務表Excel出力」ボタンでExcelファイルを保存
  - A列: 日付、B列: 曜日、C列以降: 病院名
  - セル: 勤務者名（AM/PM は後ろに付与）
  - 休日行は薄いオレンジ色で塗りつぶし
  - 人員不足箇所は赤色で表示

### CLI版

- テキスト/リッチ表形式で割り当て結果とペナルティ内訳を表示
- `--xlsx` オプションでExcel出力（GUI版と同じ形式）
